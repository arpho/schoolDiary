<ion-grid>
  <ion-row>
    <ion-col size="12">
      <div style="display: flex; align-items: center; justify-content: flex-end; padding: 10px;">
        <span style="font-size: 0.9rem; color: var(--ion-color-medium); margin-right: 10px;">Inizio periodo di riferimento:</span>
        <div id="open-date-picker-eval" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <span style="font-weight: 500; font-size: 1rem; color: var(--ion-color-primary);">{{ dataInizioPeriodo() |
            date:'dd/MM/yyyy' }}</span>
          <ion-icon name="calendar" color="primary"></ion-icon>
        </div>
        
        <ion-modal #dateModal [keepContentsMounted]="true" cssClass="datetime-modal" trigger="open-date-picker-eval">
          <ng-template>
            <ion-datetime id="startDatePickerEval" presentation="date" [value]="dataInizioPeriodo()"
              (ionChange)="onDateChange($event); dateModal.dismiss()" (ionCancel)="dateModal.dismiss()"
              [showDefaultButtons]="true">
            </ion-datetime>
          </ng-template>
        </ion-modal>
      </div>
    </ion-col>
  </ion-row>

  <ion-row>
    <ion-col size="12">
      @if (filteredEvaluations().length === 0) {
      <ion-card>
        <ion-card-content>
          <p>Nessuna valutazione trovata per questo studente nel periodo selezionato.</p>
        </ion-card-content>
      </ion-card>
      } @else {
      @for (evaluation of filteredEvaluations(); track evaluation.key) {
      <ion-card (click)="openActionSheet(evaluation, $event)">
        <ion-card-header>
          <ion-card-title>{{ evaluation.description }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item>
              <ion-label>
                <h3>attività</h3>
              </ion-label>
            </ion-item>
            <ion-item>
              <ion-label>
                <h3>Data creazione</h3>
                <p>{{ sanitizeDate(evaluation.data) |date:"dd/MM/yyyy"}}</p>
              </ion-label>
            </ion-item>
            <ion-item>
              <ion-label>
                <h3>Data ultima modifica</h3>
                <p>{{ evaluation.lastUpdateDate |date:"dd/MM/yyyy"}}</p>
              </ion-label>
            </ion-item>

            @if (evaluation.note) {
            <ion-item>
              <ion-label>
                <h3>Note</h3>
                <p>{{ evaluation.note }}</p>
              </ion-label>
            </ion-item>
            }

            @if (evaluation.subjectKey) {
            @if (getSubject(evaluation.subjectKey); as subject) {
            <ion-item>
              <ion-label>
                <h3>Materia</h3>
                <p>{{ subject.name }}</p>
              </ion-label>
            </ion-item>
            }
            }

            @if (evaluation.grid && evaluation.grid.nome) {
            <ion-item>
              <ion-label>
                <h3>Griglia di valutazione</h3>
                <p>{{ evaluation.grid.nome }}</p>
              </ion-label>
            </ion-item>
            }

            @if (evaluation.activityKey) {
            @if (getActivity(evaluation.activityKey); as activity) {
            <ion-item>

              <ion-label>
                <h3>Attività</h3>
                <p><strong>{{ activity.title }}</strong></p>
                @if (activity.description) {
                <p>{{ activity.description }}</p>
                }
              </ion-label>
            </ion-item>

            <!-- Sezione voto separata -->
            <ion-item>
              <ion-label>
                <h3>Voto</h3>
                <p><strong>{{ evaluation.voto !== undefined &amp;&amp; evaluation.voto !== null ? (evaluation.voto === 0
                    ? '0 (non ancora valutato)' : evaluation.voto) : 'N/A' }}/{{ evaluation.votoMax !== undefined
                    &amp;&amp; evaluation.votoMax !== null ? (evaluation.votoMax === 0 ? '0 (non ancora valutato)' :
                    evaluation.votoMax) : 'N/A' }}</strong></p>
              </ion-label>
            </ion-item>
            <ion-item>
              <ion-label>
                <h3>Voto decimale</h3>
                <p><strong>{{ evaluation.gradeInDecimal | number:'1.2-2'}}</strong></p>
              </ion-label>
            </ion-item>
            } @else {
            <ion-item>
              <ion-label>
                <h3>Attività</h3>
                <p>Attività non trovata ({{ evaluation.activityKey }})</p>
              </ion-label>
            </ion-item>

            <!-- Sezione voto anche se attività non trovata -->
            <ion-item>
              <ion-label>
                <h3>Voto</h3>
                <p><strong>{{ evaluation.voto !== undefined &amp;&amp; evaluation.voto !== null ? (evaluation.voto === 0
                    ? '0 (non ancora valutato)' : evaluation.voto) : 'N/A' }}/{{ evaluation.votoMax !== undefined
                    &amp;&amp; evaluation.votoMax !== null ? (evaluation.votoMax === 0 ? '0 (non ancora valutato)' :
                    evaluation.votoMax) : 'N/A' }}</strong></p>
              </ion-label>
            </ion-item>
            }
            } @else {
            <!-- Valutazione senza attività -->
            <ion-item>
              <ion-label>
                <h3>Valutazione</h3>
                <p>{{ evaluation.description }}</p>
              </ion-label>
            </ion-item>

            <!-- Sezione voto anche senza activityKey -->
            <ion-item>
              <ion-label>
                <h3>Voto</h3>
                <p><strong>{{ evaluation.voto !== undefined &amp;&amp; evaluation.voto !== null ? (evaluation.voto === 0
                    ? '0 (non ancora valutato)' : evaluation.voto) : 'N/A' }}/{{ evaluation.votoMax !== undefined
                    &amp;&amp; evaluation.votoMax !== null ? (evaluation.votoMax === 0 ? '0 (non ancora valutato)' :
                    evaluation.votoMax) : 'N/A' }}</strong></p>

              </ion-label>
            </ion-item>

            }
          </ion-list>
        </ion-card-content>
      </ion-card>
      }
      }
    </ion-col>
  </ion-row>
</ion-grid>