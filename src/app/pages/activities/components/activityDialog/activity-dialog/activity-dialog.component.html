<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>{{ activity.key ? 'Modifica' : 'Nuova' }} Attività</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="onCancel()">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <form [formGroup]="activityForm" (ngSubmit)="onSubmit()" #form="ngForm" class="form-container">
    <ion-card class="form-card">
      <ion-card-header>
        <ion-card-title class="ion-text-center">
          <ion-icon name="create" class="ion-margin-end"></ion-icon>
          Dettagli Attività
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <!-- Titolo -->
        <ion-item lines="full" class="ion-margin-bottom" [class.ion-invalid]="(titleControl?.touched || isSubmitted) && titleControl?.invalid" [class.ion-valid]="titleControl?.valid && (titleControl?.touched || isSubmitted)">
          <ion-label position="floating">Titolo <span class="required">*</span></ion-label>
          <ion-input 
            formControlName="title"
            type="text"
            required
            aria-invalid="{{ (titleControl?.touched || isSubmitted) && titleControl?.invalid ? 'true' : 'false' }}"
            aria-describedby="title-errors">
          </ion-input>
          
          <div id="title-errors" class="error-messages">
            @if ((titleControl?.touched || isSubmitted) && titleControl?.errors) {
              @if (titleControl?.errors?.['required']) {
                <ion-note color="danger">
                  <ion-icon name="warning" slot="start"></ion-icon>
                  Il titolo è obbligatorio
                </ion-note>
              }
              @if (titleControl?.errors?.['minlength']) {
                <ion-note color="danger">
                  <ion-icon name="warning" slot="start"></ion-icon>
                  Il titolo deve essere di almeno 3 caratteri
                </ion-note>
              }
              @if (titleControl?.errors?.['maxlength']) {
                <ion-note color="danger">
                  <ion-icon name="warning" slot="start"></ion-icon>
                  Il titolo non può superare i 100 caratteri
                </ion-note>
              }
            }
          </div>
        </ion-item>

        <!-- Descrizione -->
        <ion-item lines="full" class="ion-margin-bottom" [class.ion-invalid]="(descriptionControl?.touched || isSubmitted) && descriptionControl?.invalid" [class.ion-valid]="descriptionControl?.valid && (descriptionControl?.touched || isSubmitted)">
          <ion-label position="floating">Descrizione <span class="required">*</span></ion-label>
          <ion-textarea 
            formControlName="description"
            rows="4"
            required
            aria-invalid="{{ (descriptionControl?.touched || isSubmitted) && descriptionControl?.invalid ? 'true' : 'false' }}"
            aria-describedby="description-errors">
          </ion-textarea>
          
          <div id="description-errors" class="error-messages">
            @if ((descriptionControl?.touched || isSubmitted) && descriptionControl?.errors) {
              @if (descriptionControl?.errors?.['required']) {
                <ion-note color="danger">
                  <ion-icon name="warning" slot="start"></ion-icon>
                  La descrizione è obbligatoria
                </ion-note>
              }
              @if (descriptionControl?.errors?.['minlength']) {
                <ion-note color="danger">
                  <ion-icon name="warning" slot="start"></ion-icon>
                  La descrizione deve essere di almeno 10 caratteri
                </ion-note>
              }
              @if (descriptionControl?.errors?.['maxlength']) {
                <ion-note color="danger">
                  <ion-icon name="warning" slot="start"></ion-icon>
                  La descrizione non può superare i 500 caratteri
                </ion-note>
              }
            }
          </div>
        </ion-item>

        <ion-grid>
          <ion-row>
            <!-- Classe -->
            <ion-col size="12" size-md="6">
              <ion-item lines="full" class="ion-margin-bottom" [class.ion-invalid]="(classKeyControl?.touched || isSubmitted) && classKeyControl?.invalid" [class.ion-valid]="classKeyControl?.valid && (classKeyControl?.touched || isSubmitted)">
                <ion-label position="floating">Classe <span class="required">*</span></ion-label>
                <ion-select 
                  formControlName="classKey"
                  interface="action-sheet"
                  cancelText="Annulla"
                  okText="Seleziona"
                  required
                  aria-invalid="{{ (classKeyControl?.touched || isSubmitted) && classKeyControl?.invalid ? 'true' : 'false' }}"
                  aria-describedby="class-errors">
                  <ion-select-option value="">Seleziona una classe</ion-select-option>
                  @for (classe of listaClassi; track classe.key) {
                    <ion-select-option [value]="classe.key">
                      {{ classe.classe }} {{ classe.year }}
                    </ion-select-option>
                  }
                </ion-select>
                
                <div id="class-errors" class="error-messages">
                  @if ((classKeyControl?.touched || isSubmitted) && classKeyControl?.errors?.['required']) {
                    <ion-note color="danger">
                      <ion-icon name="warning" slot="start"></ion-icon>
                      Seleziona una classe
                    </ion-note>
                  }
                </div>
              </ion-item>
            </ion-col>

            <!-- Data -->
            <ion-col size="12" size-md="6">
              <ion-item lines="full" class="ion-margin-bottom" [class.ion-invalid]="(dateControl?.touched || isSubmitted) && dateControl?.invalid" [class.ion-valid]="dateControl?.valid && (dateControl?.touched || isSubmitted)">
                <ion-label position="stacked">Data <span class="required">*</span></ion-label>
                <ion-datetime 
                  formControlName="date"
                  presentation="date"
                  [min]="minDate"
                  [max]="dueDateControl?.value || ''"
                  showDefaultButtons="true"
                  showDefaultTimeLabel="true"
                  doneText="OK"
                  cancelText="Annulla"
                  required
                  aria-invalid="{{ (dateControl?.touched || isSubmitted) && dateControl?.invalid ? 'true' : 'false' }}"
                  aria-describedby="date-errors">
                </ion-datetime>
                
                <div id="date-errors" class="error-messages">
                  @if ((dateControl?.touched || isSubmitted) && dateControl?.errors) {
                    @if (dateControl?.errors?.['required']) {
                      <ion-note color="danger">
                        <ion-icon name="warning" slot="start"></ion-icon>
                        Seleziona una data
                      </ion-note>
                    }
                    @if (dateControl?.errors?.['matDatepickerMin']) {
                      <ion-note color="danger">
                        <ion-icon name="warning" slot="start"></ion-icon>
                        La data non può essere precedente a oggi
                      </ion-note>
                    }
                    @if (dateControl?.errors?.['matDatepickerMax']) {
                      <ion-note color="danger">
                        <ion-icon name="warning" slot="start"></ion-icon>
                        La data non può essere successiva alla data di scadenza
                      </ion-note>
                    }
                  }
                </div>
              </ion-item>
            </ion-col>
          </ion-row>

          <!-- Data di scadenza -->
          <ion-row>
            <ion-col size="12" size-md="6">
              <ion-item lines="full" class="ion-margin-bottom" [class.ion-invalid]="(dueDateControl?.touched || isSubmitted) && dueDateControl?.invalid" [class.ion-valid]="dueDateControl?.valid && dueDateControl?.touched">
                <ion-label position="stacked">Data Scadenza (opzionale)</ion-label>
                <ion-datetime 
                  formControlName="dueDate"
                  presentation="date"
                  [min]="dateControl?.value || minDate"
                  showDefaultButtons="true"
                  showDefaultTimeLabel="true"
                  doneText="OK"
                  cancelText="Annulla"
                  aria-invalid="{{ (dueDateControl?.touched || isSubmitted) && dueDateControl?.invalid ? 'true' : 'false' }}"
                  aria-describedby="due-date-errors">
                </ion-datetime>
                
                <div id="due-date-errors" class="error-messages">
                  @if ((dueDateControl?.touched || isSubmitted) && dueDateControl?.errors) {
                    @if (dueDateControl?.errors?.['matDatepickerMin']) {
                      <ion-note color="danger">
                        <ion-icon name="warning" slot="start"></ion-icon>
                        La data di scadenza non può essere precedente alla data di inizio
                      </ion-note>
                    }
                  }
                </div>
              </ion-item>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Pulsanti Azione -->
    <div class="form-actions">
      <ion-button 
        type="submit" 
        expand="block" 
        [disabled]="isLoading || activityForm.invalid"
        [color]="activityForm.valid ? 'primary' : 'medium'">
        <ion-spinner *ngIf="isLoading" name="crescent" class="ion-margin-end"></ion-spinner>
        <ion-icon 
          slot="start" 
          [name]="activityForm.valid ? 'checkmark-circle' : 'close-circle'"
          [color]="activityForm.valid ? 'success' : 'medium'">
        </ion-icon>
        {{ activity.key ? 'Aggiorna' : 'Crea' }} attività
      </ion-button>

      <ion-button 
        type="button" 
        expand="block" 
        fill="outline" 
        (click)="onCancel()"
        [disabled]="isLoading">
        Annulla
      </ion-button>
    </div>
  </form>

  <!-- Loading -->
  @if (isLoading) {
    <div class="loading-overlay">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
  }
</ion-content>