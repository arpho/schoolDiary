<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="onCancel()">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ isEditMode ? 'Modifica evento' : 'Nuovo evento' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="onSubmit()" [strong]="true">
        Salva
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <form [formGroup]="eventForm" (ngSubmit)="onSubmit()" class="ion-padding">
    <!-- Titolo -->
    <ion-item>
      <ion-label position="floating">Titolo <ion-text color="danger">*</ion-text></ion-label>
      <ion-input 
        formControlName="title" 
        type="text" 
        placeholder="Inserisci il titolo dell'evento"
        [maxlength]="MAX_TITLE_LENGTH"
        required>
      </ion-input>
    </ion-item>
    @if (eventForm.get('title')?.touched && eventForm.get('title')?.errors?.['required']) {
      <ion-note color="danger">
        Il titolo Ã¨ obbligatorio
      </ion-note>
    }
    @if (eventForm.get('title')?.touched && eventForm.get('title')?.errors?.['maxlength']) {
      <ion-note color="warning">
        Massimo {{MAX_TITLE_LENGTH}} caratteri
      </ion-note>
    }

    <!-- Descrizione -->
    <ion-item>
      <ion-label position="floating">Descrizione</ion-label>
      <ion-textarea 
        formControlName="description" 
        placeholder="Aggiungi una descrizione (opzionale)"
        [maxlength]="MAX_DESCRIPTION_LENGTH"
        rows="4">
      </ion-textarea>
    </ion-item>
    @if (eventForm.get('description')?.touched && eventForm.get('description')?.errors?.['maxlength']) {
      <ion-note color="warning">
        Massimo {{MAX_DESCRIPTION_LENGTH}} caratteri
      </ion-note>
    }

    <!-- Tutto il giorno -->
    <ion-item lines="none">
      <ion-label>Tutto il giorno</ion-label>
      <ion-toggle 
        slot="end" 
        formControlName="allDay"
        (ionChange)="onAllDayChange($event)">
      </ion-toggle>
    </ion-item>

    <!-- Data e ora inizio -->
    <ion-item button (click)="openDatetime('start')">
      <ion-label>Data e ora inizio <ion-text color="danger">*</ion-text></ion-label>
      <ion-text slot="end">
        {{ eventForm.get('startDate')?.value | date: (eventForm.get('allDay')?.value ? 'dd/MM/yyyy' : 'dd/MM/yyyy HH:mm') }}
      </ion-text>
    </ion-item>

    <ion-modal [isOpen]="currentDatetime?.type === 'start'" (didDismiss)="cancelDatetime()">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Seleziona data e ora inizio</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="cancelDatetime()">Annulla</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
   
          <div class="ion-padding">
            <ion-button expand="block" (click)="confirmDatetime()">Conferma</ion-button>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

    <!-- Data e ora fine -->
    <ion-item button (click)="openDatetime('end')">
      <ion-label>Data e ora fine <ion-text color="danger">*</ion-text></ion-label>
      <ion-text slot="end">
        {{ eventForm.get('endDate')?.value | date: (eventForm.get('allDay')?.value ? 'dd/MM/yyyy' : 'dd/MM/yyyy HH:mm') }}
      </ion-text>
    </ion-item>

    <ion-modal [isOpen]="currentDatetime?.type === 'end'" (didDismiss)="cancelDatetime()">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Seleziona data e ora fine</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="cancelDatetime()">Annulla</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
          <ion-datetime
            #enddatetime
            presentation="date-time"
            show-default-buttons="true"
            [display-format]="eventForm.get('allDay')?.value ? 'DD/MM/YYYY' : 'DD/MM/YYYY HH:mm'"
            [min]="eventForm.get('startDate')?.value"
            [value]="currentDatetime?.value"
            (ionchange)="onEndDateChange($event)">
          </ion-datetime>
          <div class="ion-padding">
            <ion-button expand="block" (click)="confirmDatetime()">Conferma</ion-button>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

    <!-- Classe -->
    <ion-item>
      <ion-label>Classe</ion-label>
      <ion-text slot="end">
        {{ eventForm.get('classInfo')?.value?.name || 'Nessuna classe selezionata' }}
      </ion-text>
    </ion-item>

    <!-- Pulsanti -->
    <div class="ion-padding-top">
      <ion-button 
        expand="block" 
        type="submit" 
        [disabled]="!eventForm.valid"
        class="ion-margin-top">
        <ion-icon slot="start" name="save"></ion-icon>
        {{ isEditMode ? 'Aggiorna' : 'Crea' }} evento
      </ion-button>
      
      <ion-button 
        expand="block" 
        fill="outline" 
        (click)="onCancel()"
        class="ion-margin-top">
        <ion-icon slot="start" name="close"></ion-icon>
        Annulla
      </ion-button>
    </div>
  </form>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="onCancel()" fill="clear" color="medium">
        Annulla
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button type="submit" [disabled]="!eventForm.valid" [strong]="true">
        <ion-icon slot="start" name="save"></ion-icon>
        Salva
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>
